@model FitnessSalonu.Models.Appointment

@{
    ViewData["Title"] = "Randevu Al";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card bg-dark border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header bg-black border-bottom border-warning p-4">
                    <h3 class="fw-bold m-0 text-warning text-uppercase">
                        <i class="fas fa-calendar-check me-2"></i>RANDEVU PLANLA
                    </h3>
                </div>

                <div class="card-body p-5">
                    <form asp-action="Create" id="AppointmentForm">
                        <div asp-validation-summary="All" class="text-danger mb-3 small fw-bold"></div>

                        <input type="hidden" id="SelectedTime" name="SelectedTime" />
                        <input type="hidden" asp-for="AppointmentDate" id="RealAppointmentDate" />

                        <div class="mb-4">
                            <label class="form-label text-warning fw-bold small">1. SALON SEÇİNİZ</label>
                            <select id="GymSelector" class="form-select bg-secondary text-white border-0 py-3">
                                <option value="" disabled selected>-- Salon Seçin --</option>
                                @if (ViewData["Gyms"] != null)
                                {
                                    @foreach (var gym in (IEnumerable<FitnessSalonu.Models.Gym>)ViewData["Gyms"])
                                    {
                                        <option value="@gym.Id">@gym.Name</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label asp-for="GymServiceId" class="form-label text-warning fw-bold small">2. HİZMET SEÇİNİZ</label>
                                <select asp-for="GymServiceId" id="ServiceSelector" class="form-select bg-secondary text-white border-0 py-3" disabled>
                                    <option value="" disabled selected>-- Önce Salon --</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-4">
                                <label asp-for="TrainerId" class="form-label text-warning fw-bold small">3. EĞİTMEN SEÇİNİZ</label>
                                <select asp-for="TrainerId" id="TrainerSelector" class="form-select bg-secondary text-white border-0 py-3" disabled>
                                    <option value="" disabled selected>-- Önce Hizmet --</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-warning fw-bold small">4. TARİH SEÇİNİZ</label>
                            <input type="date" id="DateSelector" class="form-control bg-secondary text-white border-0 py-3"
                                   min="@DateTime.Now.ToString("yyyy-MM-dd")" disabled />
                        </div>

                        <div id="SlotSection" style="display:none;">
                            <label class="form-label text-warning fw-bold small mb-3">5. UYGUN SAATİ SEÇİNİZ</label>

                            <div id="SlotContainer" class="d-flex flex-wrap gap-2">
                            </div>
                            <div id="NoSlotsMessage" class="alert alert-danger mt-2" style="display:none;">
                                <i class="fas fa-ban me-2"></i> Maalesef seçilen tarihte uygun boş saat kalmamış.
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-5">
                            <button type="submit" id="SubmitBtn" class="btn btn-warning btn-lg fw-bold rounded-pill text-dark shadow-sm hover-scale" disabled>
                                RANDEVUYU ONAYLA
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Slot Butonlarının Tasarımı */
    .time-slot {
        width: 100px;
        padding: 10px;
        text-align: center;
        background-color: #333;
        color: white;
        border: 1px solid #555;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .time-slot:hover {
            background-color: #444;
            border-color: #ffc107;
        }

        .time-slot.selected {
            background-color: #ffc107;
            color: black;
            font-weight: bold;
            box-shadow: 0 0 10px #ffc107;
            border-color: #ffc107;
        }

    .hover-scale:hover {
        transform: scale(1.02);
    }
</style>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {

            // 1. Salon Değişince -> Hizmet Getir
            $("#GymSelector").change(function () {
                var gymId = $(this).val();
                $("#ServiceSelector").empty().append('<option>Yükleniyor...</option>').prop('disabled', true);
                $("#TrainerSelector").empty().append('<option>-- Önce Hizmet --</option>').prop('disabled', true);
                $("#DateSelector").prop('disabled', true).val('');
                $("#SlotSection").slideUp();

                $.ajax({
                    url: '/Appointments/GetServicesByGym',
                    type: 'GET',
                    data: { gymId: gymId },
                    success: function (data) {
                        var s = $("#ServiceSelector");
                        s.empty().append('<option value="" disabled selected>-- Hizmet Seçin --</option>');
                        $.each(data, function (i, item) {
                            s.append('<option value="' + item.id + '">' + item.name + ' (' + item.durationMinutes + ' dk - ' + item.price + '₺)</option>');
                        });
                        s.prop('disabled', false);
                    }
                });
            });

            // 2. Hizmet Değişince -> Hoca Getir
            $("#ServiceSelector").change(function () {
                var serviceId = $(this).val();
                var gymId = $("#GymSelector").val();
                $("#TrainerSelector").empty().append('<option>Yükleniyor...</option>').prop('disabled', true);

                $.ajax({
                    url: '/Appointments/GetTrainersByService',
                    type: 'GET',
                    data: { gymId: gymId, serviceId: serviceId },
                    success: function (data) {
                        var t = $("#TrainerSelector");
                        t.empty().append('<option value="" disabled selected>-- Eğitmen Seçin --</option>');
                        $.each(data, function (i, item) {
                            t.append('<option value="' + item.id + '">' + item.fullName + '</option>');
                        });
                        t.prop('disabled', false);
                    }
                });
            });

            // 3. Hoca Seçilince -> Tarih Aç
            $("#TrainerSelector").change(function () {
                $("#DateSelector").prop('disabled', false);
                $("#SlotSection").slideUp();
            });

            // 4. Tarih Seçilince -> SLOTLARI GETİR
            $("#DateSelector").change(function () {
                var date = $(this).val();
                var trainerId = $("#TrainerSelector").val();
                var serviceId = $("#ServiceSelector").val();

                if(!date || !trainerId || !serviceId) return;

                $("#SlotSection").slideDown();
                $("#SlotContainer").html('<div class="text-white">Saatler hesaplanıyor...</div>');
                $("#NoSlotsMessage").hide();

                $.ajax({
                    url: '/Appointments/GetAvailableSlots',
                    type: 'GET',
                    data: { trainerId: trainerId, serviceId: serviceId, date: date },
                    success: function (slots) {
                        $("#SlotContainer").empty();

                        if (slots.length === 0) {
                            $("#NoSlotsMessage").show();
                        } else {
                            $.each(slots, function (index, time) {
                                // Butonları oluştur
                                $("#SlotContainer").append(
                                    '<div class="time-slot" onclick="selectSlot(this, \'' + time + '\')">' + time + '</div>'
                                );
                            });
                        }
                    }
                });
            });
        });

        // Slot Seçme 
        function selectSlot(element, time) {
            // Görsel seçim
            $(".time-slot").removeClass("selected");
            $(element).addClass("selected");

            //kaydet
            $("#SelectedTime").val(time);

            var date = $("#DateSelector").val();
            var fullDateTime = date + "T" + time;
            $("#RealAppointmentDate").val(fullDateTime);

            $("#SubmitBtn").prop('disabled', false);
        }
    </script>
}